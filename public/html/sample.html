<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试报告</title>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/chosen/1.8.2/chosen.css" rel="stylesheet">
    <base target="_blank">
    <style>

    </style>
</head>
<body class="gray-bg">
<div class="row  border-bottom white-bg dashboard-header">
    <div class="col-sm-12 text-center">
        <span style="color: #1ab394; font-size: 20px; font-weight: 700">小程序端Api测试报告</span>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>报告汇总</h5>
                    <!--<div class="ibox-tools">-->
                    <!--<a class="collapse-link">-->
                    <!--<i class="fa fa-chevron-up"></i>-->
                    <!--</a>-->
                    <!--<a class="close-link">-->
                    <!--<i class="fa fa-times"></i>-->
                    <!--</a>-->
                    <!--</div>-->
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-6 b-r" style="height:350px">
                            <form class="form-horizontal">
                                <!--<div class="form-group">-->
                                <!--<label class="col-sm-2 control-label text-navy">名称:</label>-->
                                <!--<div class="col-sm-5">-->
                                <!--<span class="form-control" id="testName"></span>-->
                                <!--</div>-->
                                <!--</div>-->
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-navy">用例总数:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control" id="testAll"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-navy">通过数量:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control" id="testPass"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-danger">失败数量:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control text-danger" id="testFail"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-danger">错误数量:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control text-danger" id="testError"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-warning">警告数量:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control text-warning" id="testSkip"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-navy">开始时间:</label>
                                    <div class="col-sm-5">
                                        <span class="form-control" id="beginTime"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label text-navy">运行时间(分钟):</label>
                                    <div class="col-sm-5">
                                        <span class="form-control" id="totalTime"></span>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-sm-6">
                            <div style="height:350px" id="echarts-map-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" style="margin: 3px">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>详细数据</h5>
                    <!--<div class="ibox-tools">-->
                    <!--<a class="collapse-link">-->
                    <!--<i class="fa fa-chevron-up"></i>-->
                    <!--</a>-->
                    <!--<a class="close-link">-->
                    <!--<i class="fa fa-times"></i>-->
                    <!--</a>-->
                    <!--</div>-->
                </div>
                <div class="ibox-content">
                    <div class="input-group panel-heading"
                         style="width: 100%; background-color: #1ab394; margin-bottom: 10px; text-align: left; font-family: Consolas;">
                        <label style="color: snow">测试类:</label>
                        <select class="chosen-select form-control" data-placeholder="全部" style="width: 200px;"
                                name="filterClass" id="filterClass">
                            <option value="">全部</option>
                        </select>
                        <label style="color: snow">结果:</label>
                        <select class="chosen-select form-control" data-placeholder="全部" style="width: 200px;"
                                name="filterResult" id="filterResult">
                            <option value="">全部</option>
                        </select>
                        <label style="color: snow">服务:</label>
                        <select class="chosen-select form-control" data-placeholder="全部" style="width: 200px;"
                                name="filterService" id="filterService">
                            <option value="">全部</option>
                        </select>
                        <div style="float: right">
                            <label class="form-control">
                                <span class="text-navy">用例数: </span><span class="text-navy b-r"
                                                                          id="filterAll">0</span><span> | </span>
                                <span style="color: green">成功: </span><span style="color: green"
                                                                            id="filterOk">0</span><span> | </span>
                                <span class="text-danger">错误: </span><span class="text-danger"
                                                                           id="filterError">0</span><span> | </span>
                                <span class="text-info">失败: </span><span class="text-info"
                                                                         id="filterFail">0</span><span> | </span>
                                <span class="text-warning">警告: </span><span class="text-warning"
                                                                            id="filterSkip">0</span>
                            </label>
                        </div>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>编号</th>
                            <th>测试类</th>
                            <th>测试模块</th>
                            <th>用例描述</th>
                            <th>服务</th>
                            <th>请求接口</th>
                            <th>请求数据</th>
                            <!--<th>耗时(毫秒)</th>-->
                            <th>traceid</th>
                            <th>结果</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="detailBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/echarts/3.8.5/echarts.min.js"></script>
<script src="https://cdn.bootcss.com/chosen/1.8.2/chosen.jquery.js"></script>
<script>
    //console.log('加载数据')

    function details(obj) {
        if ($(obj).text() == '展开') {
            var len = $(obj).parent().parent().children().length;
            var detailLog = "";
            var logs = resultData["testResult"][parseInt($(obj).attr("buttonIndex"))]["log"];
            var log_len = logs.length - 1;
            $(obj).text("收缩");
            $(obj).removeClass("btn-primary");
            $(obj).addClass("btn-danger");
            $.each(logs, function (i, n) {
                    var report = ""
                    switch (i) {
                        case 0:
                            detailLog = detailLog + '<span style="font-weight: bold">前置条件：</span>';
                            break;
                        case  1:
                            detailLog = detailLog + '<span style="font-weight: bold">HOST：</span>';
                            break;
                        case  2:
                            detailLog = detailLog + '<span style="font-weight: bold">status：</span>';
                            break;
                        case  3:
                            detailLog = detailLog + '<span style="font-weight: bold">code：</span>';
                            break;
                        case  4:
                            detailLog = detailLog + '<span style="font-weight: bold">Message：</span>';
                            break;
                        case  5:
                            // detailLog = detailLog + '<span style="font-weight: bold">返回数据缺损值：</span>';
                            break;
                        case  6:
                            // detailLog = detailLog + '<span style="font-weight: bold">返回类型错误：</span>';
                            break;
                        case  7:
                            report = '<span style="font-weight: bold">特别验证情况：</span>';
                            break;
                        case  8:
                            detailLog = detailLog + '<span style="font-weight: bold">执行时间：</span>';
                            break;
                        case  9:
                            detailLog = detailLog + '<span style="font-weight: bold">关联用例：</span>';
                            break;
                        case  10:
                            detailLog = detailLog + '<span style="font-weight: bold">校验值：</span>';
                            break;
                        case  11:
                            detailLog = detailLog + '<span style="font-weight: bold">返回值：</span>';
                            break;
                    }
                    if (log_len == i) {
                        detailLog = detailLog + "<p style='word-break: break-all;background-color: #ddd'>" + n + "</p>";
                    } else if (log_len - 1 == i) {
                        detailLog = detailLog + "<p style='word-break: break-all;background-color: #ccc'>" + n + "</p>";
                    } else {
                        if (i == 7 && n) {
                            detailLog = detailLog + report + "<p style='word-break: break-all;'>" + n + "</p>";
                        } else if ((i == 5) || (i == 6)) {

                        } else {
                            detailLog = detailLog + "<p style='word-break: break-all;'>" + n + "</p>";
                        }
                    }
                }
            );
            console.log(detailLog);
            $(obj).parent().parent().after("<tr><td colspan='" + len + "'><div style='font-family: Consolas;font-size:12px'>" + detailLog + "</div></td></tr>");
        } else if ($(obj).text() == '收缩') {
            $(obj).parent().parent().next().remove();
            $(obj).text("展开");
            $(obj).removeClass("btn-danger");
            $(obj).addClass("btn-primary");
        }

    }

    $(function () {
        $("#testName").text(resultData["testName"]);
        $("#testPass").text(resultData["testPass"]);
        $("#testError").text(resultData["testError"]);
        $("#testFail").text(resultData["testFail"]);
        $("#testSkip").text(resultData["testSkip"]);
        $("#testAll").text(resultData["testAll"]);
        $("#beginTime").text(resultData["beginTime"]);
        $("#totalTime").text(resultData["totalTime"]);
        var classNames = [];
        var results = [];
        var services = [];
        $.each(resultData["testResult"], function (i, n) {
            if (classNames.indexOf(n["className"]) == -1) {
                classNames.push(n["className"]);
            }
            if (results.indexOf(n["status"]) == -1) {
                results.push(n["status"]);
            }
            if (services.indexOf(n["service"]) == -1) {
                services.push(n["service"]);
            }
        });

        $.each(classNames, function (i, n) {
            $("#filterClass").append("<option value='" + n + "' hassubinfo='true'>" + n + "</option>");
        });
        $.each(results, function (i, n) {
            $("#filterResult").append("<option value='" + n + "' hassubinfo='true'>" + n + "</option>");
        });
        $.each(services, function (i, n) {
            $("#filterService").append("<option value='" + n + "' hassubinfo='true'>" + n + "</option>");
        });

        $("#filterClass").chosen({search_contains: true});
        $("#filterResult").chosen({search_contains: true});
        $("#filterService").chosen({search_contains: true});

        function generateResult(className, caseResult, caseService) {
            $("#detailBody").children().remove();
            var filterAll = 0;
            var filterOk = 0;
            var filterError = 0;
            var filterFail = 0;
            var filterSkip = 0;
            $.each(resultData["testResult"], function (i, n) {
                if ((className == "" || n["className"] == className) && (caseResult == "" || n["status"] == caseResult)
                    && (caseService == "" || n["service"] == caseService)) {
                    filterAll += 1;
                    var status = "";
                    if (n["status"] == '成功') {
                        filterOk += 1;
                        status = "<td><span class='text-navy'>成功</span></td>";
                    } else if (n["status"] == '错误') {
                        filterError += 1;
                        status = "<td><span class='text-danger'>错误</span></td>";
                    } else if (n["status"] == '失败') {
                        filterFail += 1;
                        status = "<td><span class='text-danger'>失败</span></td>";
                    } else if (n["status"] == '跳过') {
                        filterSkip += 1;
                        status = "<td><span class='text-warning'>警告</span></td>";
                    } else {
                        status = "<td><span>" + n["status"] + "</span></td>";
                    }
                    var tr = "<tr style='font-family: Consolas'>" +
                        "<td>" + (i + 1) + "</td>" +
                        "<td>" + n["className"] + "</td>" +
                        "<td>" + n["modelName"] + "</td>" +
                        "<td>" + n["caseText"] + "</td>" +
                        "<td>" + n["service"] + "</td>" +
                        "<td>" + n["methodName"] + "</td>" +
                        "<td style='max-width: 450px;max-height:75px;overflow: hidden;display: block;" +
                        "cursor: pointer'>" + n["description"] + "</td>" +
                        // "<td>" + n["spendTime"] + "</td>" +
                        "<td>" + n["traceid"] + "</td>" +
                        status + "<td><button type='button' onclick='details(this)' buttonIndex='" + i + "' class='btn btn-primary btn-xs' style='margin-bottom: 0px'>展开</button></td></tr>"
                    $("#detailBody").append(tr);
                }
            });
            $("#filterAll").text(filterAll);
            $("#filterOk").text(filterOk);
            $("#filterError").text(filterError);
            $("#filterFail").text(filterFail);
            $("#filterSkip").text(filterSkip);
        }

        generateResult("", "", "");

        $("#filterClass").on('change', function () {
            var className = $("#filterClass").val();
            var caseResult = $("#filterResult").val();
            var caseService = $("#filterService").val();
            generateResult(className, caseResult, caseService);
        });

        $("#filterResult").on('change', function () {
            var className = $("#filterClass").val();
            var caseResult = $("#filterResult").val();
            var caseService = $("#filterService").val();
            generateResult(className, caseResult, caseService);
        });

        $("#filterService").on('change', function () {
            var className = $("#filterClass").val();
            var caseResult = $("#filterResult").val();
            var caseService = $("#filterService").val();
            generateResult(className, caseResult, caseService);
        });

        //$(".chosen-select").trigger("chosen:updated");

        function pie() {
            var option = {
                title: {
                    text: '测试用例运行结果',
                    subtext: '',
                    x: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: ['错误', '失败', '成功', '警告']
                },
                series: [
                    {
                        name: '运行结果',
                        type: 'pie',
                        radius: '55%',
                        center: ['50%', '60%'],
                        data: [
                            {value: resultData["testError"], name: '错误'},
                            {value: resultData["testFail"], name: '失败'},
                            {value: resultData["testPass"], name: '成功'},
                            {value: resultData["testSkip"], name: '警告'},
                        ],
                        itemStyle: {
                            emphasis: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            var chart = echarts.init(document.getElementById("echarts-map-chart"));
            chart.setOption(option);
        }

        pie();

    });

</script>
</body>
</html>